---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="RSVP - Our Wedding">
  <main>
    <div class="container">
      <div class="rsvp-card">
        <h1>You're Invited!</h1>
        <p class="intro">Please let us know if you can make it to our special day.</p>
        
        <form id="rsvp-form">
          <!-- Main Guest Section -->
          <div class="form-section">
            <h2>Your Information</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="first_name">First Name</label>
                <input type="text" id="first_name" name="first_name" required />
              </div>
              <div class="form-group">
                <label for="last_name">Last Name</label>
                <input type="text" id="last_name" name="last_name" required />
              </div>
            </div>
            <div class="form-group">
              <label for="phone">Phone (optional)</label>
              <input type="tel" id="phone" name="phone" placeholder="+1234567890" />
            </div>
          </div>

          <div class="form-section">
            <h2>Will you be attending?</h2>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="attending" value="yes" required />
                <span class="radio-custom"></span>
                Yes, I'll be there!
              </label>
              <label class="radio-label">
                <input type="radio" name="attending" value="no" required />
                <span class="radio-custom"></span>
                Unfortunately, I can't make it
              </label>
            </div>
          </div>

          <!-- Plus One Section -->
          <div class="form-section" id="plus-one-section" style="display: none;">
            <h2>Plus One</h2>
            <div id="plus-one-allowed" style="display: none;">
              <label class="checkbox-label">
                <input type="checkbox" name="plus_one" id="plus-one-checkbox" />
                <span class="checkbox-custom"></span>
                I'm bringing a plus one
              </label>

              <div id="plus-one-details-section" style="display: none; margin-top: 1rem;">
                <h3>Plus One Details</h3>
                <div class="form-group">
                  <label for="plus_one_email">Email</label>
                  <input type="email" id="plus_one_email" name="plus_one_email" placeholder="email@example.com" />
                </div>
                <div class="form-group">
                  <label for="plus_one_first_name">First Name</label>
                  <input type="text" id="plus_one_first_name" name="plus_one_first_name" placeholder="First name" />
                </div>
                <div class="form-group">
                  <label for="plus_one_last_name">Last Name</label>
                  <input type="text" id="plus_one_last_name" name="plus_one_last_name" placeholder="Last name" />
                </div>
              </div>
            </div>
            <div id="plus-one-not-allowed" style="display: none;">
              <p class="help-text">As a plus one, you cannot bring additional guests.</p>
            </div>
          </div>

          <!-- Family Members Section -->
          <div id="family-section" style="display: none;">
            <div class="form-section family-member-section" id="family-members-container">
            </div>
          </div>

          <!-- Dietary Requirements Section -->
          <div class="form-section" id="dietary-section" style="display: none;">
            <h2>Dietary Requirements</h2>
            <p class="help-text">Select all that apply to you</p>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" name="dietary" value="vegetarian" />
                <span class="checkbox-custom"></span>
                Vegetarian
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="dietary" value="vegan" />
                <span class="checkbox-custom"></span>
                Vegan
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="dietary" value="gluten_free" />
                <span class="checkbox-custom"></span>
                Gluten Free
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="dietary" value="dairy_free" />
                <span class="checkbox-custom"></span>
                Dairy Free
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="dietary" value="halal" />
                <span class="checkbox-custom"></span>
                Halal
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="dietary" value="kosher" />
                <span class="checkbox-custom"></span>
                Kosher
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="dietary" value="nut_allergy" />
                <span class="checkbox-custom"></span>
                Nut Allergy
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="dietary" value="other" />
                <span class="checkbox-custom"></span>
                Other (please specify below)
              </label>
            </div>
            <div style="margin-top: 1rem;">
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="submit-btn">Save All Responses</button>
          </div>
        </form>

        <div id="success-message" class="success-message" style="display: none;">
          <h2>Thank you for your response!</h2>
          <p id="success-text"></p>
        </div>

        <div id="error-message" class="error-message" style="display: none;">
          <p id="error-text"></p>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  const form = document.getElementById('rsvp-form') as HTMLFormElement;
  const attendingInputs = document.getElementsByName('attending') as NodeListOf<HTMLInputElement>;
  const plusOneSection = document.getElementById('plus-one-section') as HTMLElement;
  const plusOneAllowed = document.getElementById('plus-one-allowed') as HTMLElement;
  const plusOneNotAllowed = document.getElementById('plus-one-not-allowed') as HTMLElement;
  const plusOneCheckbox = document.getElementById('plus-one-checkbox') as HTMLInputElement;
  const plusOneDetailsSection = document.getElementById('plus-one-details-section') as HTMLElement;
  const dietarySection = document.getElementById('dietary-section') as HTMLElement;
  const familySection = document.getElementById('family-section') as HTMLElement;
  const familyMembersContainer = document.getElementById('family-members-container') as HTMLElement;
  const successMessage = document.getElementById('success-message') as HTMLElement;
  const errorMessage = document.getElementById('error-message') as HTMLElement;
  const submitBtn = document.querySelector('.submit-btn') as HTMLButtonElement;

  let guestIsPlusOne = false;
  let guestUuid = '';
  let familyMembers: Array<{uuid: string; first_name: string; last_name: string; attending: boolean | null; phone: string | null; dietary_requirements: Array<{requirement_type: string}>;}> = [];

  const token = new URLSearchParams(window.location.search).get('token');

  if (!token) {
    form.style.display = 'none';
    errorMessage.style.display = 'block';
    (document.getElementById('error-text') as HTMLElement).textContent = 'Invalid RSVP link.';
  }

  async function prefetchGuestInfo() {
    if (!token) return;
    try {
      const apiHost = import.meta.env.PUBLIC_BACKEND_API_URL || '';
      const response = await fetch(`${apiHost}/api/v1/guests/${token}/info`);
      if (response.ok) {
        const data = await response.json();
        prefillForm(data);
      }
    } catch (error) {
      console.warn('Could not fetch guest info:', error);
    }
  }

  function prefillForm(data: {guest_uuid: string; first_name: string; last_name: string; phone: string | null; attending: boolean | null; is_plus_one: boolean; family_id: string | null; family_members: Array<{uuid: string; first_name: string; last_name: string; attending: boolean | null; phone: string | null; dietary_requirements: Array<{requirement_type: string; notes: string | null}>;}>; plus_one: {email: string; first_name: string; last_name: string} | null; dietary_requirements: Array<{requirement_type: string; notes: string | null}>;}) {
    guestUuid = data.guest_uuid;
    guestIsPlusOne = data.is_plus_one;
    familyMembers = data.family_members || [];

    const firstNameInput = document.getElementById('first_name') as HTMLInputElement;
    const lastNameInput = document.getElementById('last_name') as HTMLInputElement;
    const phoneInput = document.getElementById('phone') as HTMLInputElement;
    if (firstNameInput) firstNameInput.value = data.first_name || '';
    if (lastNameInput) lastNameInput.value = data.last_name || '';
    if (phoneInput && data.phone) phoneInput.value = data.phone;

    if (data.attending !== null && data.attending !== undefined) {
      const attendingInput = document.querySelector(`input[name="attending"][value="${data.attending ? 'yes' : 'no'}"]`) as HTMLInputElement;
      if (attendingInput) {
        attendingInput.checked = true;
        attendingInput.dispatchEvent(new Event('change'));
      }
    }

    if (data.plus_one && !guestIsPlusOne) {
      plusOneCheckbox.checked = true;
      plusOneDetailsSection.style.display = 'block';
      const emailInput = document.getElementById('plus_one_email') as HTMLInputElement;
      if (emailInput) emailInput.value = data.plus_one.email;
    }

    if (data.family_id && data.family_members && data.family_members.length > 0) {
      renderFamilyMembers(data.family_members);
    }

    if (data.dietary_requirements) {
      data.dietary_requirements.forEach(req => {
        const checkbox = document.querySelector(`input[name="dietary"][value="${req.requirement_type}"]`) as HTMLInputElement;
        if (checkbox) checkbox.checked = true;
        if (req.requirement_type === 'other' && req.notes) {
          const notesInput = document.getElementById('dietary_notes') as HTMLTextAreaElement;
          if (notesInput) notesInput.value = req.notes;
        }
      });
    }
  }

  function renderFamilyMembers(members: Array<{uuid: string; first_name: string; last_name: string; guest_type?: string; attending: boolean | null; phone: string | null; dietary_requirements: Array<{requirement_type: string; notes: string | null}>;}>) {
    familySection.style.display = 'block';
    familyMembersContainer.innerHTML = '';
    members.forEach((member, index) => {
      const isChild = member.guest_type === 'child';
      const childBadge = isChild ? '<span class="badge child-badge">Child</span>' : '';
      const section = document.createElement('div');
      section.className = 'family-member-card';
      section.innerHTML = `
        <h3>${member.first_name} ${member.last_name} ${childBadge}</h3>
        <input type="hidden" name="family_member_uuid_${index}" value="${member.uuid}" />
        <div class="form-section">
          <h4>Will ${member.first_name} be attending?</h4>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="family_attending_${index}" value="yes" ${member.attending === true ? 'checked' : ''} />
              <span class="radio-custom"></span>
              Yes
            </label>
            <label class="radio-label">
              <input type="radio" name="family_attending_${index}" value="no" ${member.attending === false ? 'checked' : ''} />
              <span class="radio-custom"></span>
              No
            </label>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="family_first_name_${index}">First Name</label>
            <input type="text" id="family_first_name_${index}" name="family_first_name_${index}" value="${member.first_name}" required />
          </div>
          <div class="form-group">
            <label for="family_last_name_${index}">Last Name</label>
            <input type="text" id="family_last_name_${index}" name="family_last_name_${index}" value="${member.last_name}" required />
          </div>
        </div>
        <div class="form-group">
          <label for="family_phone_${index}">Phone</label>
          <input type="tel" id="family_phone_${index}" name="family_phone_${index}" value="${member.phone || ''}" />
        </div>
      `;
      familyMembersContainer.appendChild(section);
    });
  }

  prefetchGuestInfo();

  attendingInputs.forEach(input => {
    input.addEventListener('change', (e) => {
      const attending = (e.target as HTMLInputElement).value;
      if (attending === 'yes') {
        plusOneSection.style.display = 'block';
        dietarySection.style.display = 'block';
        if (guestIsPlusOne) {
          plusOneAllowed.style.display = 'none';
          plusOneNotAllowed.style.display = 'block';
        } else {
          plusOneAllowed.style.display = 'block';
          plusOneNotAllowed.style.display = 'none';
        }
      } else {
        plusOneSection.style.display = 'none';
        dietarySection.style.display = 'none';
        plusOneCheckbox.checked = false;
        plusOneDetailsSection.style.display = 'none';
      }
    });
  });

  plusOneCheckbox.addEventListener('change', (e) => {
    const checked = (e.target as HTMLInputElement).checked;
    plusOneDetailsSection.style.display = checked ? 'block' : 'none';
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const attending = document.querySelector('input[name="attending"]:checked') as HTMLInputElement;
    const attendingValue = attending?.value === 'yes';
    const plusOne = plusOneCheckbox.checked && !guestIsPlusOne;
    const firstName = (document.getElementById('first_name') as HTMLInputElement)?.value;
    const lastName = (document.getElementById('last_name') as HTMLInputElement)?.value;
    const phone = (document.getElementById('phone') as HTMLInputElement)?.value;

    let plusOneDetails = null;
    if (plusOne) {
      const email = (document.getElementById('plus_one_email') as HTMLInputElement)?.value;
      const poFirstName = (document.getElementById('plus_one_first_name') as HTMLInputElement)?.value;
      const poLastName = (document.getElementById('plus_one_last_name') as HTMLInputElement)?.value;
      if (email && poFirstName && poLastName) {
        plusOneDetails = {email: email, first_name: poFirstName, last_name: poLastName};
      }
    }

    const dietaryCheckboxes = document.querySelectorAll('input[name="dietary"]:checked');
    const dietaryRequirements = Array.from(dietaryCheckboxes).map(cb => ({
      requirement_type: (cb as HTMLInputElement).value,
    }));

    const familyMemberUpdates: Record<string, object> = {};
    familyMembers.forEach((member, index) => {
      const memberAttending = document.querySelector(`input[name="family_attending_${index}"]:checked`) as HTMLInputElement;
      const memberAttendingValue = memberAttending?.value === 'yes';
      const memberFirstName = (document.getElementById(`family_first_name_${index}`) as HTMLInputElement)?.value;
      const memberLastName = (document.getElementById(`family_last_name_${index}`) as HTMLInputElement)?.value;
      const memberPhone = (document.getElementById(`family_phone_${index}`) as HTMLInputElement)?.value;
      
      const memberDietaryCheckboxes = document.querySelectorAll(`input[name="family_dietary_${index}"]:checked`);
      const memberDietaryRequirements = Array.from(memberDietaryCheckboxes).map(cb => ({
        requirement_type: (cb as HTMLInputElement).value,
      }));
      
      familyMemberUpdates[member.uuid] = {
        attending: memberAttendingValue,
        dietary_requirements: memberDietaryRequirements,
        guest_info: {first_name: memberFirstName, last_name: memberLastName, phone: memberPhone || null},
      };
    });

    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    try {
      const apiHost = import.meta.env.PUBLIC_BACKEND_API_URL || '';
      const response = await fetch(`${apiHost}/api/v1/guests/${token}/rsvp`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          attending: attendingValue,
          plus_one_details: plusOneDetails,
          dietary_requirements: dietaryRequirements,
          guest_info: {first_name: firstName, last_name: lastName, phone: phone || null},
          family_member_updates: familyMemberUpdates,
        })
      });

      const data = await response.json();
      if (response.ok) {
        form.style.display = 'none';
        successMessage.style.display = 'block';
        (document.getElementById('success-text') as HTMLElement).textContent = data.message;
      } else {
        errorMessage.style.display = 'block';
        (document.getElementById('error-text') as HTMLElement).textContent = data.detail || 'Error';
      }
    } catch (error) {
      errorMessage.style.display = 'block';
      (document.getElementById('error-text') as HTMLElement).textContent = 'Network error';
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Save All Responses';
    }
  });
</script>

<style>
  main {min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px;}
  .rsvp-card {background-color: var(--color-white); border-radius: 10px; padding: 40px; max-width: 700px; width: 100%; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);}
  h1 {text-align: center; color: var(--color-secondary); margin-bottom: 0.5rem;}
  .intro {text-align: center; color: var(--color-text-light); margin-bottom: 2rem;}
  .form-section {margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #eee;}
  .form-section:last-of-type {border-bottom: none;}
  .form-section h2 {font-size: 1.2rem; margin-bottom: 1rem;}
  .form-section h3 {font-size: 1.1rem; margin-bottom: 1rem;}
  .form-section h4 {font-size: 1rem; margin-bottom: 0.75rem;}
  .help-text {font-size: 0.9rem; color: var(--color-text-light); margin-bottom: 1rem;}
  .radio-group, .checkbox-group {display: flex; flex-direction: column; gap: 0.75rem;}
  .radio-label, .checkbox-label {display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; border-radius: 5px;}
  .radio-label:hover, .checkbox-label:hover {background-color: var(--color-background);}
  input[type="radio"], input[type="checkbox"] {width: 20px; height: 20px; accent-color: var(--color-primary);}
  input[type="text"], input[type="email"], input[type="tel"], textarea {width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; margin-top: 0.5rem;}
  input[type="text"]:focus, input[type="email"]:focus, textarea:focus {outline: none; border-color: var(--color-primary);}
  .form-group {margin-bottom: 1rem;}
  .form-group label {display: block; font-weight: 500; margin-bottom: 0.25rem;}
  .form-row {display: flex; gap: 1rem;}
  .form-row .form-group {flex: 1;}
  .family-member-card {background-color: var(--color-background); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;}
  .family-member-card h3 {margin-bottom: 1rem; color: var(--color-secondary);}
  .form-actions {text-align: center; margin-top: 2rem;}
  .submit-btn {background-color: var(--color-primary); color: var(--color-white); border: none; padding: 15px 40px; font-size: 1.1rem; border-radius: 5px;}
  .submit-btn:hover {background-color: var(--color-secondary);}
  .submit-btn:disabled {opacity: 0.6; cursor: not-allowed;}
  .success-message {text-align: center; padding: 2rem; background-color: var(--color-success); color: var(--color-white); border-radius: 5px;}
  .success-message h2 {color: var(--color-white);}
  .error-message {text-align: center; padding: 1rem; background-color: var(--color-error); color: var(--color-white); border-radius: 5px; margin-top: 1rem;}
</style>
